<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./assets/css/deletarevento.css">
  <title>Deletar Evento</title>
</head>
<body>
  <div class="header">
    <a href="index.html" class="logo-link"><h1>OrganiZ</h1></a>
    <a href="perfil.html"><img src="./assets/images/perfilicon.webp" alt="perfil"></a>
  </div>

  <div class="evento-lista" id="listaEventos">
    <h2>Eventos Salvos</h2>
  </div>

  <script src="./assets/js/mock-api.js"></script>
  <script src="./assets/js/login.js"></script>
  <script>
    // Função para obter o usuário atual do sessionStorage
    function getUsuarioCorrente() {
      const usuarioJSON = sessionStorage.getItem('usuarioCorrente');
      return usuarioJSON ? JSON.parse(usuarioJSON) : null;
    }

    const lista = document.getElementById("listaEventos");
    let eventos = [];

    async function carregarEventos() {
      const usuario = getUsuarioCorrente();
      if (!usuario) {
        alert('Usuário não logado');
        window.location.href = 'modulos/login/login.html';
        return;
      }

      try {
        const response = await fetch(`/eventos?usuarioId=${usuario.id}`);
        eventos = await response.json();
        renderEventos();
      } catch (error) {
        console.error('Erro ao carregar eventos:', error);
        alert('Erro ao carregar eventos');
      }
    }

    function renderEventos() {
      lista.innerHTML = "<h2>Eventos Salvos</h2>";

      if (eventos.length === 0) {
        lista.innerHTML += "<p>Não há eventos salvos.</p>";
        return;
      }

      eventos.forEach((ev) => {
        const item = document.createElement("div");
        item.className = "evento-item";
        item.innerHTML = `
          <span>${ev.titulo} — ${ev.data} — ${ev.prioridade}</span>
          <button onclick="deletarEvento(${ev.id})">Excluir</button>
        `;
        lista.appendChild(item);
      });
    }

    async function deletarEvento(eventoId) {
      if (confirm("Tem certeza que deseja excluir este evento?")) {
        try {
          const response = await fetch(`/eventos/${eventoId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            // Recarregar eventos após deletar
            await carregarEventos();
            
            if (eventos.length === 0) {
              alert("Nenhum evento restante. Voltando ao calendário.");
              window.location.href = "calendario.html";
            }
          } else {
            throw new Error('Erro ao deletar evento');
          }
        } catch (error) {
          console.error('Erro ao deletar evento:', error);
          alert('Erro ao deletar evento');
        }
      }
    }

    // Carregar eventos quando a página carregar
    window.onload = carregarEventos;
  </script>
</body>
</html>
